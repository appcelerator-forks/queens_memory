(function(){var t,e=this,n=e.Backbone,i=Array.prototype.slice,s=Array.prototype.splice;t="undefined"!=typeof exports?exports:e.Backbone={},t.VERSION="0.9.2";var r=e._;r||"undefined"==typeof require||(r=require("/alloy/underscore"));var a=e.jQuery||e.Zepto||e.ender;t.setDomLibrary=function(t){a=t},t.noConflict=function(){return e.Backbone=n,this},t.emulateHTTP=!1,t.emulateJSON=!1;var o=/\s+/,u=t.Events={on:function(t,e,n){var i,s,r,a,u;if(!e)return this;for(t=t.split(o),i=this._callbacks||(this._callbacks={});s=t.shift();)u=i[s],r=u?u.tail:{},r.next=a={},r.context=n,r.callback=e,i[s]={tail:a,next:u?u.next:r};return this},off:function(t,e,n){var i,s,a,u,l,h;if(s=this._callbacks){if(!(t||e||n))return delete this._callbacks,this;for(t=t?t.split(o):r.keys(s);i=t.shift();)if(a=s[i],delete s[i],a&&(e||n))for(u=a.tail;(a=a.next)!==u;)l=a.callback,h=a.context,(e&&l!==e||n&&h!==n)&&this.on(i,l,h);return this}},trigger:function(t){var e,n,s,r,a,u,l;if(!(s=this._callbacks))return this;for(u=s.all,t=t.split(o),l=i.call(arguments,1);e=t.shift();){if(n=s[e])for(r=n.tail;(n=n.next)!==r;)n.callback.apply(n.context||this,l);if(n=u)for(r=n.tail,a=[e].concat(l);(n=n.next)!==r;)n.callback.apply(n.context||this,a)}return this}};u.bind=u.on,u.unbind=u.off;var l=t.Model=function(t,e){var n;t||(t={}),e&&e.parse&&(t=this.parse(t)),(n=Y(this,"defaults"))&&(t=r.extend({},n,t)),e&&e.collection&&(this.collection=e.collection),this.attributes={},this._escapedAttributes={},this.cid=r.uniqueId("c"),this.changed={},this._silent={},this._pending={},this.set(t,{silent:!0}),this.changed={},this._silent={},this._pending={},this._previousAttributes=r.clone(this.attributes),this.initialize.apply(this,arguments)};r.extend(l.prototype,u,{changed:null,_silent:null,_pending:null,idAttribute:"id",initialize:function(){},toJSON:function(t){return r.clone(this.attributes)},get:function(t){return this.attributes[t]},escape:function(t){var e;if(e=this._escapedAttributes[t])return e;var n=this.get(t);return this._escapedAttributes[t]=r.escape(null==n?"":""+n)},has:function(t){return null!=this.get(t)},set:function(t,e,n){var i,s,a;if(r.isObject(t)||null==t?(i=t,n=e):(i={},i[t]=e),n||(n={}),!i)return this;if(i instanceof l&&(i=i.attributes),n.unset)for(s in i)i[s]=void 0;if(!this._validate(i,n))return!1;this.idAttribute in i&&(this.id=i[this.idAttribute]);var o=n.changes={},u=this.attributes,h=this._escapedAttributes,d=this._previousAttributes||{};for(s in i)a=i[s],(!r.isEqual(u[s],a)||n.unset&&r.has(u,s))&&(delete h[s],(n.silent?this._silent:o)[s]=!0),n.unset?delete u[s]:u[s]=a,r.isEqual(d[s],a)&&r.has(u,s)==r.has(d,s)?(delete this.changed[s],delete this._pending[s]):(this.changed[s]=a,n.silent||(this._pending[s]=!0));return n.silent||this.change(n),this},unset:function(t,e){return(e||(e={})).unset=!0,this.set(t,null,e)},clear:function(t){return(t||(t={})).unset=!0,this.set(r.clone(this.attributes),t)},fetch:function(e){e=e?r.clone(e):{};var n=this,i=e.success;return e.success=function(t,s,r){return!!n.set(n.parse(t,r),e)&&void(i&&i(n,t))},e.error=t.wrapError(e.error,n,e),(this.sync||t.sync).call(this,"read",this,e)},save:function(e,n,i){var s,a;if(r.isObject(e)||null==e?(s=e,i=n):(s={},s[e]=n),i=i?r.clone(i):{},i.wait){if(!this._validate(s,i))return!1;a=r.clone(this.attributes)}var o=r.extend({},i,{silent:!0});if(s&&!this.set(s,i.wait?o:i))return!1;var u=this,l=i.success;i.success=function(t,e,n){var a=u.parse(t,n);return i.wait&&(delete i.wait,a=r.extend(s||{},a)),!!u.set(a,i)&&void(l?l(u,t):u.trigger("sync",u,t,i))},i.error=t.wrapError(i.error,u,i);var h=this.isNew()?"create":"update",d=(this.sync||t.sync).call(this,h,this,i);return i.wait&&this.set(a,o),d},destroy:function(e){e=e?r.clone(e):{};var n=this,i=e.success,s=function(){n.trigger("destroy",n,n.collection,e)};if(this.isNew())return s(),!1;e.success=function(t){e.wait&&s(),i?i(n,t):n.trigger("sync",n,t,e)},e.error=t.wrapError(e.error,n,e);var a=(this.sync||t.sync).call(this,"delete",this,e);return e.wait||s(),a},url:function(){var t=Y(this,"urlRoot")||Y(this.collection,"url")||x();return this.isNew()?t:t+("/"==t.charAt(t.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(t,e){return t},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},change:function(t){t||(t={});var e=this._changing;this._changing=!0;for(var n in this._silent)this._pending[n]=!0;var i=r.extend({},t.changes,this._silent);this._silent={};for(var n in i)this.trigger("change:"+n,this,this.get(n),t);if(e)return this;for(;!r.isEmpty(this._pending);){this._pending={},this.trigger("change",this,t);for(var n in this.changed)this._pending[n]||this._silent[n]||delete this.changed[n];this._previousAttributes=r.clone(this.attributes)}return this._changing=!1,this},hasChanged:function(t){return arguments.length?r.has(this.changed,t):!r.isEmpty(this.changed)},changedAttributes:function(t){if(!t)return!!this.hasChanged()&&r.clone(this.changed);var e,n=!1,i=this._previousAttributes;for(var s in t)r.isEqual(i[s],e=t[s])||((n||(n={}))[s]=e);return n},previous:function(t){return arguments.length&&this._previousAttributes?this._previousAttributes[t]:null},previousAttributes:function(){return r.clone(this._previousAttributes)},isValid:function(){return!this.validate(this.attributes)},_validate:function(t,e){if(e.silent||!this.validate)return!0;t=r.extend({},this.attributes,t);var n=this.validate(t,e);return!n||(e&&e.error?e.error(this,n,e):this.trigger("error",this,n,e),!1)}});var h=t.Collection=function(t,e){e||(e={}),e.model&&(this.model=e.model),e.comparator&&(this.comparator=e.comparator),this._reset(),this.initialize.apply(this,arguments),t&&this.reset(t,{silent:!0,parse:e.parse})};r.extend(h.prototype,u,{model:l,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},add:function(t,e){var n,i,a,o,u,l,h={},d={},c=[];for(e||(e={}),t=r.isArray(t)?t.slice():[t],n=0,a=t.length;n<a;n++){if(!(o=t[n]=this._prepareModel(t[n],e)))throw new Error("Can't add an invalid model to a collection");u=o.cid,l=o.id,h[u]||this._byCid[u]||null!=l&&(d[l]||this._byId[l])?c.push(n):h[u]=d[l]=o}for(n=c.length;n--;)t.splice(c[n],1);for(n=0,a=t.length;n<a;n++)(o=t[n]).on("all",this._onModelEvent,this),this._byCid[o.cid]=o,null!=o.id&&(this._byId[o.id]=o);if(this.length+=a,i=null!=e.at?e.at:this.models.length,s.apply(this.models,[i,0].concat(t)),this.comparator&&this.sort({silent:!0}),e.silent)return this;for(n=0,a=this.models.length;n<a;n++)h[(o=this.models[n]).cid]&&(e.index=n,o.trigger("add",o,this,e));return this},remove:function(t,e){var n,i,s,a;for(e||(e={}),t=r.isArray(t)?t.slice():[t],n=0,i=t.length;n<i;n++)a=this.getByCid(t[n])||this.get(t[n]),a&&(delete this._byId[a.id],delete this._byCid[a.cid],s=this.indexOf(a),this.models.splice(s,1),this.length--,e.silent||(e.index=s,a.trigger("remove",a,this,e)),this._removeReference(a));return this},push:function(t,e){return t=this._prepareModel(t,e),this.add(t,e),t},pop:function(t){var e=this.at(this.length-1);return this.remove(e,t),e},unshift:function(t,e){return t=this._prepareModel(t,e),this.add(t,r.extend({at:0},e)),t},shift:function(t){var e=this.at(0);return this.remove(e,t),e},get:function(t){if(null!=t)return this._byId[null!=t.id?t.id:t]},getByCid:function(t){return t&&this._byCid[t.cid||t]},at:function(t){return this.models[t]},where:function(t){return r.isEmpty(t)?[]:this.filter(function(e){for(var n in t)if(t[n]!==e.get(n))return!1;return!0})},sort:function(t){if(t||(t={}),!this.comparator)throw new Error("Cannot sort a set without a comparator");var e=r.bind(this.comparator,this);return 1==this.comparator.length?this.models=this.sortBy(e):this.models.sort(e),t.silent||this.trigger("reset",this,t),this},pluck:function(t){return r.map(this.models,function(e){return e.get(t)})},reset:function(t,e){t||(t=[]),e||(e={});for(var n=0,i=this.models.length;n<i;n++)this._removeReference(this.models[n]);return this._reset(),this.add(t,r.extend({silent:!0},e)),e.silent||this.trigger("reset",this,e),this},fetch:function(e){e=e?r.clone(e):{},void 0===e.parse&&(e.parse=!0);var n=this,i=e.success;return e.success=function(t,s,r){n[e.add?"add":"reset"](n.parse(t,r),e),i&&i(n,t)},e.error=t.wrapError(e.error,n,e),(this.sync||t.sync).call(this,"read",this,e)},create:function(t,e){var n=this;if(e=e?r.clone(e):{},t=this._prepareModel(t,e),!t)return!1;e.wait||n.add(t,e);var i=e.success;return e.success=function(s,r,a){e.wait&&n.add(s,e),i?i(s,r):s.trigger("sync",t,r,e)},t.save(null,e),t},parse:function(t,e){return t},chain:function(){return r(this.models).chain()},_reset:function(t){this.length=0,this.models=[],this._byId={},this._byCid={}},_prepareModel:function(t,e){if(e||(e={}),t instanceof l)t.collection||(t.collection=this);else{var n=t;e.collection=this,t=new this.model(n,e),t._validate(t.attributes,e)||(t=!1)}return t},_removeReference:function(t){this==t.collection&&delete t.collection,t.off("all",this._onModelEvent,this)},_onModelEvent:function(t,e,n,i){("add"!=t&&"remove"!=t||n==this)&&("destroy"==t&&this.remove(e,i),e&&t==="change:"+e.idAttribute&&(delete this._byId[e.previous(e.idAttribute)],this._byId[e.id]=e),this.trigger.apply(this,arguments))}});var d=["forEach","each","map","reduce","reduceRight","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","sortBy","sortedIndex","toArray","size","first","initial","rest","last","without","indexOf","shuffle","lastIndexOf","isEmpty","groupBy"];r.each(d,function(t){h.prototype[t]=function(){return r[t].apply(r,[this.models].concat(r.toArray(arguments)))}});var c=t.Router=function(t){t||(t={}),t.routes&&(this.routes=t.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},f=/:\w+/g,m=/\*\w+/g,_=/[-[\]{}()+?.,\\^$|#\s]/g;r.extend(c.prototype,u,{initialize:function(){},route:function(e,n,i){return t.history||(t.history=new g),r.isRegExp(e)||(e=this._routeToRegExp(e)),i||(i=this[n]),t.history.route(e,r.bind(function(s){var r=this._extractParameters(e,s);i&&i.apply(this,r),this.trigger.apply(this,["route:"+n].concat(r)),t.history.trigger("route",this,n,r)},this)),this},navigate:function(e,n){t.history.navigate(e,n)},_bindRoutes:function(){if(this.routes){var t=[];for(var e in this.routes)t.unshift([e,this.routes[e]]);for(var n=0,i=t.length;n<i;n++)this.route(t[n][0],t[n][1],this[t[n][1]])}},_routeToRegExp:function(t){return t=t.replace(_,"\\$&").replace(f,"([^/]+)").replace(m,"(.*?)"),new RegExp("^"+t+"$")},_extractParameters:function(t,e){return t.exec(e).slice(1)}});var g=t.History=function(){this.handlers=[],r.bindAll(this,"checkUrl")},p=/^[#\/]/,y=/msie [\w.]+/;g.started=!1,r.extend(g.prototype,u,{interval:50,getHash:function(t){var e=t?t.location:window.location,n=e.href.match(/#(.*)$/);return n?n[1]:""},getFragment:function(t,e){if(null==t)if(this._hasPushState||e){t=window.location.pathname;var n=window.location.search;n&&(t+=n)}else t=this.getHash();return t.indexOf(this.options.root)||(t=t.substr(this.options.root.length)),t.replace(p,"")},start:function(t){if(g.started)throw new Error("Backbone.history has already been started");g.started=!0,this.options=r.extend({},{root:"/"},this.options,t),this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&window.history&&window.history.pushState);var e=this.getFragment(),n=document.documentMode,i=y.exec(navigator.userAgent.toLowerCase())&&(!n||n<=7);i&&(this.iframe=a('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(e)),this._hasPushState?a(window).bind("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!i?a(window).bind("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=e;var s=window.location,o=s.pathname==this.options.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!o?(this.fragment=this.getFragment(null,!0),window.location.replace(this.options.root+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&o&&s.hash&&(this.fragment=this.getHash().replace(p,""),window.history.replaceState({},document.title,s.protocol+"//"+s.host+this.options.root+this.fragment)),this.options.silent?void 0:this.loadUrl())},stop:function(){a(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),g.started=!1},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(t){var e=this.getFragment();return e==this.fragment&&this.iframe&&(e=this.getFragment(this.getHash(this.iframe))),e!=this.fragment&&(this.iframe&&this.navigate(e),void(this.loadUrl()||this.loadUrl(this.getHash())))},loadUrl:function(t){var e=this.fragment=this.getFragment(t),n=r.any(this.handlers,function(t){if(t.route.test(e))return t.callback(e),!0});return n},navigate:function(t,e){if(!g.started)return!1;e&&e!==!0||(e={trigger:e});var n=(t||"").replace(p,"");this.fragment!=n&&(this._hasPushState?(0!=n.indexOf(this.options.root)&&(n=this.options.root+n),this.fragment=n,window.history[e.replace?"replaceState":"pushState"]({},document.title,n)):this._wantsHashChange?(this.fragment=n,this._updateHash(window.location,n,e.replace),this.iframe&&n!=this.getFragment(this.getHash(this.iframe))&&(e.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,n,e.replace))):window.location.assign(this.options.root+t),e.trigger&&this.loadUrl(t))},_updateHash:function(t,e,n){n?t.replace(t.toString().replace(/(javascript:|#).*$/,"")+"#"+e):t.hash=e}});var v=t.View=function(t){this.cid=r.uniqueId("view"),this._configure(t||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},w=/^(\S+)\s*(.*)$/,S=["model","collection","el","id","attributes","className","tagName"];r.extend(v.prototype,u,{tagName:"div",$:function(t){return this.$el.find(t)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this},make:function(t,e,n){var i=document.createElement(t);return e&&a(i).attr(e),n&&a(i).html(n),i},setElement:function(t,e){return this.$el&&this.undelegateEvents(),this.$el=t instanceof a?t:a(t),this.el=this.$el[0],e!==!1&&this.delegateEvents(),this},delegateEvents:function(t){if(t||(t=Y(this,"events"))){this.undelegateEvents();for(var e in t){var n=t[e];if(r.isFunction(n)||(n=this[t[e]]),!n)throw new Error('Method "'+t[e]+'" does not exist');var i=e.match(w),s=i[1],a=i[2];n=r.bind(n,this),s+=".delegateEvents"+this.cid,""===a?this.$el.bind(s,n):this.$el.delegate(a,s,n)}}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(t){this.options&&(t=r.extend({},this.options,t));for(var e=0,n=S.length;e<n;e++){var i=S[e];t[i]&&(this[i]=t[i])}this.options=t},_ensureElement:function(){if(this.el)this.setElement(this.el,!1);else{var t=Y(this,"attributes")||{};this.id&&(t.id=this.id),this.className&&(t.class=this.className),this.setElement(this.make(this.tagName,t),!1)}}});var k=function(t,e){var n=b(this,t,e);return n.extend=this.extend,n};l.extend=h.extend=c.extend=v.extend=k;var M={create:"POST",update:"PUT",delete:"DELETE",read:"GET"};t.sync=function(e,n,i){var s=M[e];i||(i={});var o={type:s,dataType:"json"};return i.url||(o.url=Y(n,"url")||x()),i.data||!n||"create"!=e&&"update"!=e||(o.contentType="application/json",o.data=JSON.stringify(n.toJSON())),t.emulateJSON&&(o.contentType="application/x-www-form-urlencoded",o.data=o.data?{model:o.data}:{}),t.emulateHTTP&&("PUT"!==s&&"DELETE"!==s||(t.emulateJSON&&(o.data._method=s),o.type="POST",o.beforeSend=function(t){t.setRequestHeader("X-HTTP-Method-Override",s)})),"GET"===o.type||t.emulateJSON||(o.processData=!1),a.ajax(r.extend(o,i))},t.wrapError=function(t,e,n){return function(i,s){s=i===e?s:i,t?t(e,s,n):e.trigger("error",e,s,n)}};var D=function(){},b=function(t,e,n){var i;return i=e&&e.hasOwnProperty("constructor")?e.constructor:function(){t.apply(this,arguments)},r.extend(i,t),D.prototype=t.prototype,i.prototype=new D,e&&r.extend(i.prototype,e),n&&r.extend(i,n),i.prototype.constructor=i,i.__super__=t.prototype,i},Y=function(t,e){return t&&t[e]?r.isFunction(t[e])?t[e]():t[e]:null},x=function(){throw new Error('A "url" property or function must be specified')}}).call(this);